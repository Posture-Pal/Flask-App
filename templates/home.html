{% extends "base.html" %}

{% block title %}PosturePal - Home{% endblock %}

{% block content %}
<div class="greeting"><p>Hello, {{ user }}!</p></div> <!-- Shows "Hello" followed by the user's name after they log in -->

<div class="postureGoalContainer">
    {% if sensor_data %}
        <canvas id="postureChart" class="chartCanvas"></canvas>
        <script>
            // Prepare posture data
            const sensorData = {{ sensor_data | tojson }};
            const timestamps = sensorData.map(entry => new Date(entry.timestamp).toLocaleTimeString());
            const postureLabels = sensorData.map(entry => entry.pitch < -50 ? "Good Posture" : "Bad Posture");
            const postureValues = sensorData.map(entry => entry.pitch);

            // Line chart configuration
            const ctx = document.getElementById('postureChart').getContext('2d');
            const chart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: timestamps,
                    datasets: [{
                        label: 'Pitch Angle (째)',
                        data: postureValues,
                        backgroundColor: 'rgba(54, 162, 235, 0.2)',
                        borderColor: 'rgba(54, 162, 235, 1)',
                        borderWidth: 1,
                        pointBackgroundColor: postureLabels.map(label => label === "Good Posture" ? 'green' : 'red'),
                        pointBorderColor: postureLabels.map(label => label === "Good Posture" ? 'green' : 'red'),
                        pointRadius: 5
                    }]
                },
                options: {
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'Time',
                            },
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'Pitch Angle (째)',
                            },
                            suggestedMin: -100,
                            suggestedMax: 0
                        }
                    },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const index = context.dataIndex;
                                    const posture = postureLabels[index];
                                    return `${context.raw}째 (${posture})`;
                                }
                            }
                        }
                    }
                }
            });
        </script>
    {% else %}
        <p>No sensor data available.</p>
    {% endif %}
    <div class="percentPosture">85%</div> <!-- TODO Replace 85% with actual posture score -->
    <div>You are meeting your posture goal!</div> <!-- TODO Replace with conditional message to display if they are meeting their posture goal -->
</div>

<div class="usageContainer">
    <div class="usageContainerFlex">
        <div class="usageCard">
            <img class="navicons" src="https://img.icons8.com/fluency-systems-regular/50/2b617d/clock--v1.png" alt="clock icon" />
            <div class="usageSmallText">Usage Today</div>
            <div class="usageBoldText">11 Hours</div> <!-- TODO Replace with actual usage -->
        </div>
        <div class="usageCard">
            <img class="navicons" src="https://img.icons8.com/fluency-systems-regular/50/2b617d/push-notifications.png" alt="notifications icon" />
            <div class="usageSmallText">Reminders</div>
            <div class="usageBoldText">7</div> <!-- TODO Replace with actual usage -->
        </div>
        <div class="usageCard">
            <img class="navicons" src="https://img.icons8.com/windows/32/2b617d/inclination.png" alt="angle icon" />
            <div class="usageSmallText">Average Angle</div>
            <div class="usageBoldText">15째</div> <!-- TODO Replace with actual usage -->
        </div>
    </div>
</div>

{% if show_calibration_modal %}
<div id="calibrationModal" class="modal" style="display:block;">
    <div class="modal-content">
        <span class="close-button" onclick="closeModal()">&times;</span>
        <h2>Calibrate Your Posture</h2>
        <p>Please stand up straight and click the button below to save your good posture</p>
        <button id="saveDataButton">Confirm Posture</button>
        <p id="statusMessage"></p>
    </div>
</div>
{% endif %}

<a href="{{ url_for('logout') }}">Logout</a>

{% endblock %}